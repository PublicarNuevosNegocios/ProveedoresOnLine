@model MarketPlace.Models.Provider.ProviderViewModel

@{
    ViewBag.Title = "Proveedores OnLine - Evaluación de desempeño";
    Layout = MVC.Desktop.Shared.Views._Layout;

    //get evaluation area to show
    List<MarketPlace.Models.Survey.SurveyConfigItemViewModel> lstEvaluationArea = Model.RelatedSurvey.GetSurveyConfigItem(MarketPlace.Models.General.enumSurveyConfigItemType.EvaluationArea, null);

    if (Model.RelatedSurvey.SurveyConfigStepEnable)
    {
        lstEvaluationArea = new List<MarketPlace.Models.Survey.SurveyConfigItemViewModel>()
        {
            lstEvaluationArea.Where(x => x.Order == Model.RelatedSurvey.CurrentStepId).FirstOrDefault(),
        };
    }

    //get mandatory info
    Tuple<int, int> MandatoryInfo = Model.RelatedSurvey.GetMandatoryAnsweredQuestions();

    //get finalize url
    string strFinalizeUrl = Url.RouteUrl(MarketPlace.Models.General.Constants.C_Routes_Default,
        new
        {
            controller = MVC.Survey.Name,
            action = MVC.Survey.ActionNames.SurveyFinalize,
            SurveyPublicId = Model.RelatedSurvey.SurveyPublicId
        });
}
<div>
    <!--survey header-->
    <div class="PMMPSurveyHeader">
        <!--Provider info-->
        <div class="POMPProviderMenuDetail">
            @Html.Partial(MVC.Desktop.Shared.Views._P_ProviderLite, Model.RelatedLiteProvider)
        </div>
        <!--Survey info-->
        <div class="PMMPSurveyProviderInfo">
            <ul>
                <li class="PMMPProviderDetail">
                    <span>
                        @((string.IsNullOrEmpty(Model.RelatedSurvey.SurveyConfigGroup) ? string.Empty : (Model.RelatedSurvey.SurveyConfigGroup + " - ")) + Model.RelatedSurvey.SurveyConfigName)
                    </span>
                </li>
                <li class="PMMPProviderDetail">
                    <div>
                        <div class="rateit" data-rateit-value="@Model.RelatedSurvey.SurveyRating.ToString("0.##").Replace(",",".")" data-rateit-ispreset="true" data-rateit-readonly="true"></div>
                        <span>(@Model.RelatedSurvey.SurveyRating.ToString("0.##").Replace(",", "."))</span>
                    </div>
                </li>
                <li class="PMMPProviderDetail">
                    <div>
                        <div class="selProgressBar" data-value="@Model.RelatedSurvey.SurveyProgress"></div>
                        <span>(@MandatoryInfo.Item2/@MandatoryInfo.Item1)</span>
                    </div>
                </li>
                <li>
                    <span>Estado: @Model.RelatedSurvey.SurveyStatusName</span>
                    <span>Fecha de programación: @Model.RelatedSurvey.SurveyIssueDate</span>
                </li>
                <li>
                    <span>Evaluador: @Model.RelatedSurvey.SurveyEvaluator</span>
                    <span>Ultima actualización: @Model.RelatedSurvey.SurveyLastModify</span>
                </li>
                <li>
                    <span>Responsable: @Model.RelatedSurvey.SurveyResponsible</span>
                </li>
            </ul>
        </div>
    </div>
    @if (Model.RelatedSurvey.SurveyStatus == MarketPlace.Models.General.enumSurveyStatus.Close)
    {
        <div class="PMMPSurveyFinished">
            La evaluación de desempeño se encuentra finalizada y no puede ser modificada.
        </div>
    }
    else
    {
    <!--Survey questions body-->
        <div class="PMMPSurveyQuestions">
            <!--evaluation items-->
            <form id="SurveySave_Form" method="post">
                <ul>
                    <!--Survey Actions-->
                    <li>
                        <div class="POMPResultsActions">
                            <ul>
                                @if (Model.RelatedSurvey.SurveyConfigStepEnable)
                                {
                                    if (Model.RelatedSurvey.CurrentActionMenu.LastMenu != null)
                                    {
                                        <li>
                                            <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.LastMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.LastMenu.Name</a>
                                        </li>
                                    }
                                    if (Model.RelatedSurvey.CurrentActionMenu.NextMenu != null)
                                    {
                                        <li>
                                            <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.NextMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.NextMenu.Name</a>
                                        </li>
                                    }
                                }
                                @if (MandatoryInfo.Item1 == MandatoryInfo.Item2)
                                {
                                <!--Survey 100%-->
                                    <li>
                                        <a href="javascript:Survey_SaveObject.Finalize('@strFinalizeUrl')">Finalizar evaluación</a>
                                    </li>
                                }
                                <li>
                                    <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.Name</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    @foreach (var EvaluationArea in lstEvaluationArea)
                    {
                        var EvaluationAreaInfo = Model.RelatedSurvey.GetSurveyItem(EvaluationArea.SurveyConfigItemId);

                        var lstQuestion = Model.RelatedSurvey.GetSurveyConfigItem
                            (MarketPlace.Models.General.enumSurveyConfigItemType.Question, EvaluationArea.SurveyConfigItemId);
                        <li class="PMMPEvaluationArea">
                            <span class="PMMPMandatorySurvey">Los campos con <span class="PMMPMandatory">*</span> son obligatorios</span>

                            <span><span class="PMMPNumeric">@EvaluationArea.Order.</span> @EvaluationArea.Name</span>

                            <ul>
                                @foreach (var Question in lstQuestion)
                                {
                                    var QuestionInfo = Model.RelatedSurvey.GetSurveyItem(Question.SurveyConfigItemId);

                                    var lstAnswer = Model.RelatedSurvey.GetSurveyConfigItem
                                        (MarketPlace.Models.General.enumSurveyConfigItemType.Answer, Question.SurveyConfigItemId);

                                    <li>
                                        @if (Question.IsMandatory)
                                        {
                                            <span class="PMMPMandatory">*</span>
                                        }
                                        <span><span class="PMMPNumeric">@Question.Order.</span> @Question.Name</span>
                                        <ul>
                                            @foreach (var Answer in lstAnswer)
                                            {
                                                <li>
                                                    @if (QuestionInfo != null && QuestionInfo.Answer == Answer.SurveyConfigItemId)
                                                    {
                                                        <input name="SurveyItem_@Question.SurveyConfigItemId" type="radio" value="@Answer.SurveyConfigItemId" checked="checked" @(Model.RelatedSurvey.SurveyStatus == MarketPlace.Models.General.enumSurveyStatus.Close ? "disabled=\"disabled\"" : string.Empty) />
                                                    }
                                                    else
                                                    {
                                                        <input name="SurveyItem_@Question.SurveyConfigItemId" type="radio" value="@Answer.SurveyConfigItemId" @(Model.RelatedSurvey.SurveyStatus == MarketPlace.Models.General.enumSurveyStatus.Close ? "disabled=\"disabled\"" : string.Empty) />
                                                    }
                                                    <span>@Answer.Name</span>
                                                </li>
                                            }
                                        </ul>
                                        @if (Question.HasDescription)
                                        {
                                            <div class="POMPDescription">
                                                <span>
                                                    Observaciones:
                                                </span>
                                                <span>
                                                    <textarea rows="5" cols="80" name="SurveyItemText_@Question.SurveyConfigItemId" @(Model.RelatedSurvey.SurveyStatus == MarketPlace.Models.General.enumSurveyStatus.Close ? "readonly=\"readonly\"" : string.Empty)>@(QuestionInfo == null ? string.Empty : QuestionInfo.DescriptionText.Trim())</textarea>
                                                </span>
                                            </div>
                                        }
                                    </li>
                                }
                            </ul>
                        </li>
                    }
                    <!--Survey Actions-->
                    <li>
                        <div class="POMPResultsActions">
                            <ul>
                                @if (Model.RelatedSurvey.SurveyConfigStepEnable)
                                {
                                    if (Model.RelatedSurvey.CurrentActionMenu.LastMenu != null)
                                    {
                                        <li>
                                            <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.LastMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.LastMenu.Name</a>
                                        </li>
                                    }
                                    if (Model.RelatedSurvey.CurrentActionMenu.NextMenu != null)
                                    {
                                        <li>
                                            <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.NextMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.NextMenu.Name</a>
                                        </li>
                                    }
                                }
                                @if (MandatoryInfo.Item1 == MandatoryInfo.Item2)
                                {
                                <!--Survey 100%-->
                                    <li>
                                        <a href="javascript:Survey_SaveObject.Finalize('@strFinalizeUrl')">Finalizar evaluación</a>
                                    </li>
                                }
                                <li>
                                    <a href="javascript:Survey_SaveObject.Save('@Model.RelatedSurvey.CurrentActionMenu.Url')">@Model.RelatedSurvey.CurrentActionMenu.Name</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                </ul>

                <div style="display:none;">
                    <input type="hidden" id="SurveySave_Status" name="SurveyInfo_@(((int)MarketPlace.Models.General.enumSurveyInfoType.Status).ToString())_@Model.RelatedSurvey.SurveyStatusId" value="@(((int)MarketPlace.Models.General.enumSurveyStatus.InProgress).ToString())" />
                </div>
            </form>
        </div>
    }
</div>
<div style="display:none;">
    <div id="SurveySave_Finalize_Dialog" title="Finalizar evaluación de desempeño">
        <p>
            Al finalizar la evaluación de desempeño esta se sumara en el promedio final del proveedor y la evaluación no podra ser editada nuevamente.
        </p>
        <p>
            Desea finalizar la evaluación de desempeño?
        </p>
    </div>
</div>
@section inlinescripts
{
    <script type="text/javascript">
        $(document).ready(function () {
            Survey_SaveObject.Init({
                ObjectId: 'SurveySave',
            });
        });
    </script>
}

